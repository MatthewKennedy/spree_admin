<% content_for :page_title do %>
  <%= plural_resource_name(Spree::Order) %>
<% end %>

<% content_for :page_actions do %>
  <%= link_to_with_icon Spree.t(:new_order), new_admin_order_path, class: "btn-primary btn", icon: 'plus-square.svg', id: 'admin_new_order' %>
<% end if can? :create, Spree::Order %>

<%#-------------------------------------------------%>
<%# Index Table                                     %>
<%#-------------------------------------------------%>
<% content_for :index_table_filter_tabs do %>
  <%= link_to Spree.t('admin.orders.all'), spree.admin_orders_path(q: { completed_at_not_null: 1 }), class: "#{'active' if params[:q][:payment_state_not_eq].blank? && params[:q][:shipment_state_not_eq].blank?}" %>
  <%= link_to Spree.t('admin.orders.unpaid'), params.merge({q: {payment_state_not_eq: :paid, completed_at_not_null: 1}}).permit!, class: "#{'active' if params[:q][:payment_state_not_eq] == 'paid'}" %>
  <%= link_to Spree.t('admin.orders.unfulfilled'), params.merge({q: {shipment_state_not_eq: :shipped, completed_at_not_null: 1}}).permit!, class: "#{'active' if params[:q][:shipment_state_not_eq] == 'shipped'}" %>
<% end %>

<% content_for :index_table_filter_buttons do %>
  <%= link_to I18n.t('spree.admin.more_filters'), spree.filter_admin_orders_path(request.query_parameters), class: "btn btn-outline-secondary", data: {turbo_frame: :offcanvas} %>
<% end %>

<% content_for :index_table do %>
  <% if @orders.any? %>
    <table class="table table-hover" id="listing_orders">
      <thead class="text-muted">
        <tr data-hook="admin_orders_index_headers">
          <th><%= I18n.t(:number, scope: 'activerecord.attributes.spree/order') %></th>
          <th><%= I18n.t('spree.admin.date') %></th>
          <th><%= I18n.t('spree.admin.risk') %></th>
          <th><%= I18n.t('spree.admin.payment') %></th>
          <th><%= I18n.t('spree.admin.shipment') %></th>
          <th><%= I18n.t('spree.admin.customer') %></th>
          <th><%= I18n.t('spree.admin.total') %></th>
        </tr>
      </thead>
      <tbody>
        <% @orders.each do |order| %>
          <tr data-hook="admin_orders_index_rows" class="state-<%= order.state.downcase %> <%= "text-muted" if order.shipment_state == 'shipped' %>">
            <td data-controller="linkable-td" data-linkable-td-uri-value="<%= spree.edit_admin_order_path(order) %>" class="text-nowrap">
              <%= link_to order.number, edit_admin_order_path(order), class: 'text-reset text-decoration-none' %>
            </td>

            <td data-controller="linkable-td" data-linkable-td-uri-value="<%= spree.edit_admin_order_path(order) %>" class="text-nowrap">
              <%= order_time(@show_only_completed ? order.completed_at : order.created_at) %>
            </td>

            <td data-controller="linkable-td" data-linkable-td-uri-value="<%= spree.edit_admin_order_path(order) %>" class="text-nowrap">
              <span class="badge rounded-pill bg-<%= order.considered_risky ? 'considered_risky' : 'considered_safe' %>">
                <%= order.considered_risky ? I18n.t("spree.admin.risky") : I18n.t("spree.admin.safe") %>
              </span>
            </td>

            <td data-controller="linkable-td" data-linkable-td-uri-value="<%= spree.edit_admin_order_path(order) %>" class="text-nowrap">
              <% if order.payment_state %>
                <span class="badge rounded-pill bg-<%= order.payment_state %>">
                  <%= I18n.t("spree.admin.payment_states.#{order.payment_state}") %>
                </span>
              <% end %>
            </td>

            <% if Spree::Order.checkout_step_names.include?(:delivery) %>
              <td data-controller="linkable-td" data-linkable-td-uri-value="<%= spree.edit_admin_order_path(order) %>" class="text-nowrap">
                <% if order.shipment_state %>
                  <span class="badge rounded-pill bg-<%= order.shipment_state %>">
                    <%= I18n.t("spree.admin.shipment_states.#{order.shipment_state}") %>
                  </span>
                <% end %>
              </td>
            <% end %>
            <td class="text-nowrap dropdown">
              <button class="btn btn-light btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                  <%= order.email %>
                </button>
                <% if order.user %>
                  <ul class="dropdown-menu">
                    <li><%= link_to order.email, spree.edit_admin_user_path(order.user), class: 'dropdown-item' %></li>
                  </ul>
                <% else %>
                  <%= mail_to order.email %>
                <% end %>
            </td>
            <td data-controller="linkable-td" data-linkable-td-uri-value="<%= spree.edit_admin_order_path(order) %>">
              <%= order.display_total.to_html %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  <% else %>
    <div class="text-center no-objects-found m-5">
      <%= Spree.t(:no_resource_found, resource: plural_resource_name(Spree::Order)) %>
    </div>
  <% end %>
<% end %>

<%#-------------------------------------------------%>
<%# Render the index_table partial passing a        %>
<%# search_field_value and search_field_placeholder %>
<%# text if you want to add a search bar            %>
<%#-------------------------------------------------%>
  <%= render partial: "spree/admin/shared/index_table",
             locals: { search_record: :number_i_cont,
                       search_placeholder: I18n.t('spree.admin.products.search_all_orders_by_number') } %>
